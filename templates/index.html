<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Predyktor Energii PV</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { height: 300px; margin-bottom: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>Predyktor Energii z Instalacji PV</h1>

  <div id="map"></div>
  <label>Sprawność (η): <input type="number" id="eta" value="0.18" step="0.01"></label>
  <label>Powierzchnia [m²]: <input type="number" id="area" value="10" step="1"></label>
  <button onclick="loadData()">Pobierz dane</button>

  <p><strong>Całkowita energia (przez tydzień):</strong> <span id="energyTotal">-</span> kWh</p>

  <div id="chart" style="width:100%;height:400px;"></div>
  <h3>Dane godzinowe (24h):</h3>
  <table id="dataTable"></table>

  <h3>Podsumowanie dzienne:</h3>
  <table id="summaryTable"></table>

  <script>
    let lat = 52.0;
    let lon = 21.0;

    const map = L.map('map').setView([lat, lon], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const marker = L.marker([lat, lon], {draggable: true}).addTo(map);
    marker.on('dragend', () => {
      const pos = marker.getLatLng();
      lat = pos.lat.toFixed(4);
      lon = pos.lng.toFixed(4);
    });

    function buildTable(data, tableId) {
      const table = document.getElementById(tableId);
      table.innerHTML = '';
      const headers = Object.keys(data[0]);
      const thead = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
      const rows = data.map(row => {
        return '<tr>' + headers.map(h => `<td>${row[h]}</td>`).join('') + '</tr>';
      }).join('');
      table.innerHTML = thead + rows;
    }

    function loadData() {
      const eta = document.getElementById('eta').value;
      const area = document.getElementById('area').value;
      fetch(`/data?lat=${lat}&lon=${lon}&eta=${eta}&area=${area}`)
        .then(res => res.json())
        .then(({ records, summary, total_energy }) => {
          document.getElementById('energyTotal').textContent = total_energy;

          const times = records.map(r => r.time);
          const powers = records.map(r => r.pv_power);

          Plotly.newPlot('chart', [{
            x: times,
            y: powers,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Moc PV [W]'
          }], {
            xaxis: {
              nticks: 10
            },
            yaxis: {
              title: 'Moc [W]'
            },
            margin: { b: 80 }
          });

          buildTable(records.slice(0, 24), 'dataTable');
          buildTable(summary, 'summaryTable');
        });
    }

    window.onload = loadData;
  </script>
</body>
</html>